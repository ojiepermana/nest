# RBAC Examples - Real-World Usage

Complete examples demonstrating RBAC integration with generated code.

**Date**: November 10, 2025  
**Version**: v1.0.6

---

## Table of Contents

1. [Basic Setup](#basic-setup)
2. [Generated Code with RBAC](#generated-code-with-rbac)
3. [Permission Management](#permission-management)
4. [Role Management](#role-management)
5. [Field-Level Permissions](#field-level-permissions)
6. [Row-Level Security](#row-level-security)
7. [Custom Permissions](#custom-permissions)
8. [Complete Application Example](#complete-application-example)

---

## Basic Setup

### 1. Install Dependencies

```bash
npm install @ojiepermana/nest-generator
npm install @nestjs/cache-manager cache-manager
npm install pg # or mysql2
```

### 2. Setup Database Schema

```bash
# PostgreSQL
psql -U postgres -d myapp -f node_modules/@ojiepermana/nest-generator/rbac/schemas/postgresql-rbac.sql

# MySQL
mysql -u root -p myapp < node_modules/@ojiepermana/nest-generator/rbac/schemas/mysql-rbac.sql
```

### 3. Configure App Module

```typescript
// app.module.ts
import { Module } from '@nestjs/common';
import { RBACModule } from '@ojiepermana/nest-generator/rbac';
import { ConfigModule, ConfigService } from '@nestjs/config';

@Module({
  imports: [
    ConfigModule.forRoot(),
    
    // RBAC Module - Global by default
    RBACModule.register({
      adminRoles: ['admin', 'super_admin'],
      superAdminRole: 'super_admin',
      useGlobalGuards: true, // Apply to all routes
      cache: {
        enabled: true,
        ttl: 300, // 5 minutes
        prefix: 'rbac',
      },
    }),
    
    // Your feature modules
    UsersModule,
    ProductsModule,
  ],
})
export class AppModule {}
```

### 4. Alternative: Async Configuration

```typescript
RBACModule.registerAsync({
  imports: [ConfigModule],
  useFactory: (config: ConfigService) => ({
    adminRoles: config.get('ADMIN_ROLES', 'admin,super_admin').split(','),
    superAdminRole: config.get('SUPER_ADMIN_ROLE', 'super_admin'),
    useGlobalGuards: config.get('RBAC_GLOBAL_GUARDS', true),
    cache: {
      enabled: config.get('CACHE_ENABLED', true),
      ttl: config.get('CACHE_TTL', 300),
    },
  }),
  inject: [ConfigService],
})
```

---

## Generated Code with RBAC

### Generate Module with RBAC

```bash
# Using CLI
nest-generator generate users --features.rbac=true --rbacResourceName=users

# This generates:
# - Controller with @RequirePermission decorators
# - Permission seed SQL
# - Full CRUD with RBAC protection
```

### Generated Controller

```typescript
// users.controller.ts (auto-generated)
import { Controller, Get, Post, Put, Delete, Body, Param } from '@nestjs/common';
import { RequirePermission } from '@ojiepermana/nest-generator/rbac';
import { UsersService } from './users.service';
import { CreateUserDto, UpdateUserDto } from './dto';

@Controller('users')
export class UsersController {
  constructor(private readonly service: UsersService) {}

  @RequirePermission('users.create')
  @Post()
  async create(@Body() dto: CreateUserDto) {
    return this.service.create(dto);
  }

  @RequirePermission('users.read')
  @Get()
  async findAll() {
    return this.service.findAll();
  }

  @RequirePermission('users.read')
  @Get(':id')
  async findOne(@Param('id') id: string) {
    return this.service.findOne(id);
  }

  @RequirePermission('users.update')
  @Put(':id')
  async update(@Param('id') id: string, @Body() dto: UpdateUserDto) {
    return this.service.update(id, dto);
  }

  @RequirePermission('users.delete')
  @Delete(':id')
  async remove(@Param('id') id: string) {
    return this.service.remove(id);
  }
}
```

### Generated Permission Seed SQL

```sql
-- users Permissions
-- Auto-generated by nest-generator
-- Generated at: 2025-11-10T10:00:00.000Z

INSERT INTO rbac.permissions (code, name, description, category, is_active)
VALUES ('users.create', 'Create users', 'Permission to create new users', 'users', true)
ON CONFLICT (code) DO UPDATE
SET name = EXCLUDED.name, description = EXCLUDED.description, updated_at = NOW();

INSERT INTO rbac.permissions (code, name, description, category, is_active)
VALUES ('users.read', 'Read users', 'Permission to view users records', 'users', true)
ON CONFLICT (code) DO UPDATE
SET name = EXCLUDED.name, description = EXCLUDED.description, updated_at = NOW();

INSERT INTO rbac.permissions (code, name, description, category, is_active)
VALUES ('users.update', 'Update users', 'Permission to update users records', 'users', true)
ON CONFLICT (code) DO UPDATE
SET name = EXCLUDED.name, description = EXCLUDED.description, updated_at = NOW();

INSERT INTO rbac.permissions (code, name, description, category, is_active)
VALUES ('users.delete', 'Delete users', 'Permission to delete users records', 'users', true)
ON CONFLICT (code) DO UPDATE
SET name = EXCLUDED.name, description = EXCLUDED.description, updated_at = NOW();
```

---

## Permission Management

### Creating Custom Permissions

```typescript
import { Injectable } from '@nestjs/common';
import { RBACRepository } from '@ojiepermana/nest-generator/rbac';

@Injectable()
export class PermissionService {
  constructor(private readonly rbacRepo: RBACRepository) {}

  async setupProductPermissions() {
    // Create resource permissions
    await this.rbacRepo.createPermission({
      code: 'products.export',
      name: 'Export Products',
      description: 'Permission to export products to CSV',
      category: 'products',
      resource: 'products',
      action: 'export',
    });

    await this.rbacRepo.createPermission({
      code: 'products.import',
      name: 'Import Products',
      description: 'Permission to import products from CSV',
      category: 'products',
      resource: 'products',
      action: 'import',
    });

    await this.rbacRepo.createPermission({
      code: 'products.approve',
      name: 'Approve Products',
      description: 'Permission to approve product listings',
      category: 'products',
      resource: 'products',
      action: 'approve',
    });
  }
}
```

### Using Custom Permissions in Controllers

```typescript
@Controller('products')
export class ProductsController {
  constructor(private readonly service: ProductsService) {}

  @RequirePermission('products.export')
  @Get('export')
  async export(@Query() filters: ProductFilterDto) {
    return this.service.exportToCSV(filters);
  }

  @RequirePermission('products.import')
  @Post('import')
  @UseInterceptors(FileInterceptor('file'))
  async import(@UploadedFile() file: Express.Multer.File) {
    return this.service.importFromCSV(file);
  }

  @RequirePermission('products.approve')
  @Put(':id/approve')
  async approve(@Param('id') id: string) {
    return this.service.approve(id);
  }
}
```

---

## Role Management

### Creating Roles

```typescript
import { Injectable } from '@nestjs/common';
import { RBACRepository } from '@ojiepermana/nest-generator/rbac';

@Injectable()
export class RoleService {
  constructor(private readonly rbacRepo: RBACRepository) {}

  async setupRoles() {
    // Create Admin Role
    const admin = await this.rbacRepo.createRole({
      code: 'admin',
      name: 'Administrator',
      description: 'Full system access',
      level: 1,
    });

    // Create Manager Role
    const manager = await this.rbacRepo.createRole({
      code: 'manager',
      name: 'Manager',
      description: 'Team management access',
      level: 2,
      parent_id: admin.id, // Hierarchy: admin > manager
    });

    // Create Staff Role
    const staff = await this.rbacRepo.createRole({
      code: 'staff',
      name: 'Staff',
      description: 'Basic access',
      level: 3,
      parent_id: manager.id, // Hierarchy: manager > staff
    });

    return { admin, manager, staff };
  }
}
```

### Assigning Permissions to Roles

```typescript
async setupRolePermissions() {
  // Admin gets all permissions
  await this.rbacRepo.grantPermissionToRole('admin', 'users.create');
  await this.rbacRepo.grantPermissionToRole('admin', 'users.read');
  await this.rbacRepo.grantPermissionToRole('admin', 'users.update');
  await this.rbacRepo.grantPermissionToRole('admin', 'users.delete');
  await this.rbacRepo.grantPermissionToRole('admin', 'products.approve');

  // Manager gets limited permissions
  await this.rbacRepo.grantPermissionToRole('manager', 'users.read');
  await this.rbacRepo.grantPermissionToRole('manager', 'users.update');
  await this.rbacRepo.grantPermissionToRole('manager', 'products.read');
  await this.rbacRepo.grantPermissionToRole('manager', 'products.update');

  // Staff gets read-only
  await this.rbacRepo.grantPermissionToRole('staff', 'users.read');
  await this.rbacRepo.grantPermissionToRole('staff', 'products.read');
}
```

### Assigning Roles to Users

```typescript
async assignRolesToUser(userId: string) {
  // Assign role without expiration
  await this.rbacRepo.assignRoleToUser(userId, 'staff');

  // Assign role with expiration (30 days)
  const expiresAt = new Date();
  expiresAt.setDate(expiresAt.getDate() + 30);
  await this.rbacRepo.assignRoleToUser(userId, 'manager', expiresAt);

  // Assign multiple roles
  await Promise.all([
    this.rbacRepo.assignRoleToUser(userId, 'staff'),
    this.rbacRepo.assignRoleToUser(userId, 'viewer'),
  ]);
}
```

### Using Role Decorators

```typescript
import { RequireRole, RequireAdmin } from '@ojiepermana/nest-generator/rbac';

@Controller('admin')
export class AdminController {
  @RequireAdmin() // Shortcut for admin role
  @Get('dashboard')
  async getDashboard() {
    return { message: 'Admin Dashboard' };
  }

  @RequireRole(['manager', 'admin'], { logic: RoleLogic.OR })
  @Get('reports')
  async getReports() {
    return { message: 'Management Reports' };
  }

  @RequireRole(['admin', 'super_admin'], { 
    logic: RoleLogic.AND,
    activeOnly: true,
    checkExpiration: true 
  })
  @Delete('users/:id')
  async deleteUser(@Param('id') id: string) {
    return { message: 'User deleted' };
  }
}
```

---

## Field-Level Permissions

### Protecting Sensitive Fields

```typescript
import { Injectable } from '@nestjs/common';
import { RBACService } from '@ojiepermana/nest-generator/rbac';

@Injectable()
export class UsersService {
  constructor(private readonly rbacService: RBACService) {}

  async getUserProfile(userId: string, currentUserId: string) {
    const user = await this.userRepository.findOne(userId);

    // Filter fields based on user permissions
    const allowedFields = await this.rbacService.filterFields(
      currentUserId,
      'users',
      Object.keys(user),
      user,
    );

    // Return only allowed fields
    const filteredUser = {};
    for (const field of allowedFields) {
      filteredUser[field] = user[field];
    }

    return filteredUser;
  }
}
```

### Setting Field Permissions in Database

```sql
-- Allow only admins to see salary field
INSERT INTO rbac.field_permissions (permission_id, field_name, access_level, condition)
SELECT p.id, 'salary', 'read', '{"role": "admin"}'
FROM rbac.permissions p
WHERE p.code = 'users.read';

-- Allow managers to see email but not edit
INSERT INTO rbac.field_permissions (permission_id, field_name, access_level, condition)
SELECT p.id, 'email', 'read', '{"role": "manager"}'
FROM rbac.permissions p
WHERE p.code = 'users.update';
```

---

## Row-Level Security

### Ownership-Based Access

```typescript
import { RequireOwnership } from '@ojiepermana/nest-generator/rbac';

@Controller('posts')
export class PostsController {
  constructor(private readonly service: PostsService) {}

  // Users can only update their own posts
  @RequireOwnership('posts.update', 'author_id')
  @Put(':id')
  async update(
    @Param('id') id: string,
    @Body() dto: UpdatePostDto,
    @CurrentUser() user: any,
  ) {
    return this.service.update(id, dto);
  }

  // Users can only delete their own posts
  @RequireOwnership('posts.delete')
  @Delete(':id')
  async delete(@Param('id') id: string, @CurrentUser() user: any) {
    return this.service.delete(id);
  }
}
```

### Service-Level Ownership Check

```typescript
@Injectable()
export class PostsService {
  constructor(
    private readonly rbacService: RBACService,
    private readonly repository: PostsRepository,
  ) {}

  async update(id: string, dto: UpdatePostDto, userId: string) {
    // Manual ownership check
    const canUpdate = await this.rbacService.checkOwnership(
      userId,
      id,
      'posts',
      'author_id',
    );

    if (!canUpdate) {
      throw new ForbiddenException('You can only update your own posts');
    }

    return this.repository.update(id, dto);
  }
}
```

### Dynamic Row Filters

```typescript
async getMyPosts(userId: string, filters: PostFilterDto) {
  // Get row-level filters based on user permissions
  const rowFilters = await this.rbacService.buildRowFilters(
    userId,
    'posts',
    'read',
    filters,
  );

  // Apply filters to query
  const posts = await this.repository.findWithFilters({
    ...filters,
    ...rowFilters,
  });

  return posts;
}
```

---

## Custom Permissions

### Conditional Permissions

```typescript
@Controller('products')
export class ProductsController {
  // Only allow product updates during business hours
  @RequirePermission('products.update', {
    errorMessage: 'Product updates are only allowed during business hours',
  })
  @Put(':id')
  async update(
    @Param('id') id: string,
    @Body() dto: UpdateProductDto,
    @CurrentUser() user: any,
  ) {
    const currentHour = new Date().getHours();
    if (currentHour < 9 || currentHour > 17) {
      throw new ForbiddenException('Updates allowed only 9 AM - 5 PM');
    }

    return this.service.update(id, dto, user.id);
  }
}
```

### Multiple Permission Logic

```typescript
// User must have BOTH permissions
@RequireAllPermissions(['products.read', 'products.export'])
@Get('export')
async export() {
  return this.service.exportData();
}

// User must have AT LEAST ONE permission
@RequireAnyPermission(['products.read', 'admin.access'])
@Get()
async findAll() {
  return this.service.findAll();
}

// Complex permission logic
@RequirePermission(['products.delete', 'admin.access'], {
  logic: PermissionLogic.OR,
  errorMessage: 'You need delete permission or admin access',
})
@Delete(':id')
async remove(@Param('id') id: string) {
  return this.service.remove(id);
}
```

---

## Complete Application Example

### Full E-Commerce Application

```typescript
// main.ts
import { NestFactory } from '@nestjs/core';
import { AppModule } from './app.module';

async function bootstrap() {
  const app = await NestFactory.create(AppModule);
  await app.listen(3000);
  console.log('Application with RBAC is running on: http://localhost:3000');
}
bootstrap();
```

```typescript
// app.module.ts
import { Module } from '@nestjs/common';
import { ConfigModule } from '@nestjs/config';
import { RBACModule } from '@ojiepermana/nest-generator/rbac';
import { UsersModule } from './modules/users/users.module';
import { ProductsModule } from './modules/products/products.module';
import { OrdersModule } from './modules/orders/orders.module';

@Module({
  imports: [
    ConfigModule.forRoot({ isGlobal: true }),
    
    RBACModule.register({
      adminRoles: ['admin', 'super_admin'],
      superAdminRole: 'super_admin',
      useGlobalGuards: true,
      cache: { enabled: true, ttl: 300 },
    }),
    
    UsersModule,
    ProductsModule,
    OrdersModule,
  ],
})
export class AppModule {}
```

```typescript
// products.module.ts (Generated + Enhanced)
import { Module } from '@nestjs/common';
import { ProductsController } from './products.controller';
import { ProductsService } from './products.service';
import { ProductsRepository } from './products.repository';

@Module({
  controllers: [ProductsController],
  providers: [ProductsService, ProductsRepository],
  exports: [ProductsService],
})
export class ProductsModule {}
```

```typescript
// products.controller.ts (Generated with RBAC)
import { Controller, Get, Post, Put, Delete, Body, Param, Query } from '@nestjs/common';
import { RequirePermission, RequireOwnership } from '@ojiepermana/nest-generator/rbac';
import { ProductsService } from './products.service';
import { CreateProductDto, UpdateProductDto, ProductFilterDto } from './dto';

@Controller('products')
export class ProductsController {
  constructor(private readonly service: ProductsService) {}

  @RequirePermission('products.create')
  @Post()
  async create(@Body() dto: CreateProductDto) {
    return this.service.create(dto);
  }

  @RequirePermission('products.read')
  @Get()
  async findAll(@Query() filters: ProductFilterDto) {
    return this.service.findAll(filters);
  }

  @RequirePermission('products.read')
  @Get(':id')
  async findOne(@Param('id') id: string) {
    return this.service.findOne(id);
  }

  @RequireOwnership('products.update', 'created_by')
  @Put(':id')
  async update(@Param('id') id: string, @Body() dto: UpdateProductDto) {
    return this.service.update(id, dto);
  }

  @RequireOwnership('products.delete', 'created_by')
  @Delete(':id')
  async remove(@Param('id') id: string) {
    return this.service.remove(id);
  }

  @RequirePermission('products.approve')
  @Put(':id/approve')
  async approve(@Param('id') id: string) {
    return this.service.approve(id);
  }

  @RequirePermission('products.export')
  @Get('export/csv')
  async exportCSV(@Query() filters: ProductFilterDto) {
    return this.service.exportToCSV(filters);
  }
}
```

### Seed Script for Permissions & Roles

```typescript
// scripts/seed-rbac.ts
import { NestFactory } from '@nestjs/core';
import { AppModule } from '../src/app.module';
import { RBACRepository } from '@ojiepermana/nest-generator/rbac';

async function seedRBAC() {
  const app = await NestFactory.createApplicationContext(AppModule);
  const rbacRepo = app.get(RBACRepository);

  console.log('Seeding RBAC data...');

  // Create Roles
  const superAdmin = await rbacRepo.createRole({
    code: 'super_admin',
    name: 'Super Administrator',
    description: 'Full system access',
    level: 1,
  });

  const admin = await rbacRepo.createRole({
    code: 'admin',
    name: 'Administrator',
    description: 'Administrative access',
    level: 2,
    parent_id: superAdmin.id,
  });

  const manager = await rbacRepo.createRole({
    code: 'manager',
    name: 'Manager',
    description: 'Management access',
    level: 3,
    parent_id: admin.id,
  });

  const staff = await rbacRepo.createRole({
    code: 'staff',
    name: 'Staff',
    description: 'Basic access',
    level: 4,
    parent_id: manager.id,
  });

  // Create Permissions (Products)
  const permissions = [
    { code: 'products.create', name: 'Create Product' },
    { code: 'products.read', name: 'Read Product' },
    { code: 'products.update', name: 'Update Product' },
    { code: 'products.delete', name: 'Delete Product' },
    { code: 'products.approve', name: 'Approve Product' },
    { code: 'products.export', name: 'Export Products' },
  ];

  for (const perm of permissions) {
    await rbacRepo.createPermission({
      ...perm,
      description: `${perm.name} permission`,
      category: 'products',
      resource: 'products',
      action: perm.code.split('.')[1],
    });
  }

  // Assign Permissions to Roles
  await rbacRepo.grantPermissionToRole('super_admin', 'products.create');
  await rbacRepo.grantPermissionToRole('super_admin', 'products.read');
  await rbacRepo.grantPermissionToRole('super_admin', 'products.update');
  await rbacRepo.grantPermissionToRole('super_admin', 'products.delete');
  await rbacRepo.grantPermissionToRole('super_admin', 'products.approve');
  await rbacRepo.grantPermissionToRole('super_admin', 'products.export');

  await rbacRepo.grantPermissionToRole('admin', 'products.create');
  await rbacRepo.grantPermissionToRole('admin', 'products.read');
  await rbacRepo.grantPermissionToRole('admin', 'products.update');
  await rbacRepo.grantPermissionToRole('admin', 'products.approve');

  await rbacRepo.grantPermissionToRole('manager', 'products.read');
  await rbacRepo.grantPermissionToRole('manager', 'products.update');

  await rbacRepo.grantPermissionToRole('staff', 'products.read');

  console.log('RBAC seeding complete!');
  await app.close();
}

seedRBAC().catch(console.error);
```

---

## Testing RBAC

### Unit Tests

```typescript
import { Test } from '@nestjs/testing';
import { ProductsController } from './products.controller';
import { ProductsService } from './products.service';
import { RBACService } from '@ojiepermana/nest-generator/rbac';

describe('ProductsController with RBAC', () => {
  let controller: ProductsController;
  let rbacService: RBACService;

  beforeEach(async () => {
    const module = await Test.createTestingModule({
      controllers: [ProductsController],
      providers: [
        ProductsService,
        {
          provide: RBACService,
          useValue: {
            hasPermission: jest.fn(),
            checkOwnership: jest.fn(),
          },
        },
      ],
    }).compile();

    controller = module.get(ProductsController);
    rbacService = module.get(RBACService);
  });

  it('should allow product creation with permission', async () => {
    jest.spyOn(rbacService, 'hasPermission').mockResolvedValue({ granted: true });
    
    const result = await controller.create({ name: 'Test Product' });
    
    expect(result).toBeDefined();
  });
});
```

---

## Best Practices

1. **Always use global module**: `isGlobal: true` (default)
2. **Enable caching**: Reduce database queries
3. **Use ownership checks**: For user-specific resources
4. **Hierarchical roles**: Implement role inheritance
5. **Granular permissions**: Use resource.action format
6. **Audit logging**: Enable for security compliance
7. **Regular cleanup**: Remove expired role assignments
8. **Test permissions**: Write unit tests for RBAC logic

---

## Common Patterns

### Admin Override

```typescript
// Admins can access all resources
if (await this.rbacService.isAdmin(userId)) {
  return data; // Skip permission check
}
```

### Time-Based Permissions

```typescript
// Grant temporary access
const expiresAt = new Date();
expiresAt.setHours(expiresAt.getHours() + 24); // 24 hours
await rbacRepo.assignRoleToUser(userId, 'temp_admin', expiresAt);
```

### Bulk Permission Checks

```typescript
// Check multiple permissions at once
const permissions = await rbacService.hasAllPermissions(userId, [
  'products.create',
  'products.update',
  'products.delete',
]);

if (permissions.granted) {
  // User has all permissions
}
```

---

## Troubleshooting

### Permission Denied Errors

```typescript
// Check user permissions
const userPerms = await rbacService.getUserPermissions(userId);
console.log('User permissions:', userPerms);

// Check specific permission
const hasPerm = await rbacService.hasPermission(userId, 'products.create');
console.log('Has permission:', hasPerm);
```

### Cache Issues

```typescript
// Clear cache for user
await cacheManager.del(`rbac:permissions:${userId}`);
await cacheManager.del(`rbac:roles:${userId}`);
```

### Role Hierarchy Not Working

```sql
-- Verify role hierarchy
SELECT r1.code as role, r2.code as parent
FROM rbac.roles r1
LEFT JOIN rbac.roles r2 ON r1.parent_id = r2.id;
```

---

## Next Steps

- Read [RBAC_GUIDE.md](./RBAC_GUIDE.md) for complete API reference
- See [RBAC_QUICKSTART.md](../quickstart/RBAC_QUICKSTART.md) for 10-minute setup
- Check [IMPLEMENTATION_STATUS.md](./IMPLEMENTATION_STATUS.md) for feature status

---

**Generated by**: @ojiepermana/nest-generator v1.0.6  
**Last Updated**: November 10, 2025
